# === Data Settings ===
data:
  input_file: "data/merged.parquet"
  features_file: "/mnt/c/Users/Alice/OneDrive - 청주대학교/근전도 분석 코드/EMG_analysis/output/meta_merged.csv"
  id_columns:
    subject: "subject"
    velocity: "velocity"
    trial: "trial_num"
    frame: "DeviceFrame"
    mocap_frame: "MocapFrame"
    onset: "platform_onset"
    offset: "platform_offset"
    task: "task"
  task_filter: "perturb"
  # Sampling rates (MocapFrame → DeviceFrame)
  device_sample_rate: 1000
  mocap_sample_rate: 100

# === Signal Groups ===
signal_groups:
  emg:
    columns: [TA, EHL, MG, SOL, PL, RF, VL, ST, RA, EO, IO, SCM, GM, ESC, EST, ESL]
    grid_layout: [4, 4]
  forceplate:
    columns: [Fx_zero, Fy_zero, Fz_zero, Mx_zero, My_zero, Mz_zero]
    grid_layout: [2, 3]
  cop:
    columns: [Cx_zero, Cy_zero]
    grid_layout: [1, 3]
  com:
    columns: [COMx_zero, COMy_zero, COMz_zero]
    grid_layout: [1, 4]
    time_base: mocap
    optional: true

# === Interpolation ===
interpolation:
  target_length: 500
  start_ms: -100
  end_ms: 800

# === Aggregation Modes ===
# Filter 옵션 설명:
#   - 딕셔너리 형식: filter: { mixed: 1, age_group: "young" }
#   - 단일 컬럼: filter: { mixed: 1 }
#   - 다중 컬럼: 모든 조건을 AND로 결합
aggregation_modes:
  step_TF_mean:
    enabled: true
    filter:
      mixed: 1
      age_group: "young"
    groupby: ["step_TF"]
    color_by: ["step_TF"]
    overlay: true
    overlay_within: ["step_TF"]
    output_dir: "step_TF"
    filename_pattern: "step_TF_mean_{signal_group}.png"
  diff_step_TF_subject_mean:
    enabled: true
    filter:
      mixed: 1
      age_group: "young"
    groupby: ["step_TF","subject"]
    color_by: ["step_TF"]
    overlay: true
    overlay_within: ["step_TF"]
    output_dir: "step_TF_subject"
    filename_pattern: "step_TF_{subject}_mean_{signal_group}.png"



# === 플롯 스타일 ===
plot_style:
  # 공통 설정 (모든 신호 타입에 적용)
  common:
    dpi: 300
    grid_alpha: 0.3                    # 격자선 투명도 (0=완전투명, 1=완전불투명)
    tick_labelsize: 7                  # 축 눈금 폰트 크기 (포인트)
    title_fontsize: 14                 # 제목 폰트 크기
    title_fontweight: "bold"           # 제목 굵기 ("bold", "normal")
    title_pad: 5                       # 제목과 그래프 사이 간격 (포인트)
    label_fontsize: 8                  # 축 라벨 폰트 크기
    legend_loc: "best"                 # legend 위치 ("best", "upper left", "lower right" 등)
    legend_framealpha: 0.8             # legend 배경 투명도
    legend_label_threshold: 6          # groupby column의 unique 값이 이 값 이상이면 legend에서 제외
    tight_layout_rect: [0, 0, 1, 0.99] # 레이아웃 여백 [left, bottom, right, top]
    savefig_bbox_inches: "tight"       # 저장 시 테두리 처리 ("tight"로 여백 최소화)
    savefig_facecolor: "white"         # 배경색 ("white", "gray" 등)
    font_family: "NanumGothic"         # 폰트 ("NanumGothic", "Arial" 등)
    show_max_marker: false             # 최댓값 마커 표시 여부
    use_group_colors: false            # 그룹별 색상 사용 여부 (true=색상, false=라인스타일만)
    window_colors:                     # 각 윈도우 기간별 색상 (p1~p4)
      p1: "#4E79A7"                    # 0-200ms (파란색)
      p2: "#F28E2B"                    # 200-400ms (주황색)
      p3: "#E15759"                    # 400-600ms (빨간색)
      p4: "#59A14F"                    # 600-800ms (초록색)
    # group_linestyles 사용법:
    # - 기본 값: "-", "--", ":", "-."
    # - 커스텀 dash: [offset, [on, off, on, off, ...]] 형태
    group_linestyles: ["-", "--", ":", "-.", [0, [1, 1]], [0, [3, 1, 1, 1]]]

  # EMG 신호 전용 설정
  emg:
    subplot_size: [18, 9]              # 그리드 크기 (가로, 세로) 인치. 예: [18,9]는 18"x9" 캔버스
    line_color: "gray"                 # 라인 색상 (RGB 색상명 또는 16진수 "#0000FF")
    line_width: 1.2                    # 라인 두께 (포인트)
    line_alpha: 0.8                    # 라인 투명도 (0=투명, 1=불투명)
    window_span_alpha: 0.15            # 윈도우 배경 투명도 (p1,p2,p3,p4 구간 표시용)
    max_marker_color: "orange"         # 최댓값 마커 색상
    max_marker_linestyle: "--"         # 최댓값 마커 스타일
    max_marker_linewidth: 1.5          # 최댓값 마커 두께
    legend_fontsize: 4                 # legend 폰트 크기 (채널이 많아서 작게 설정)
    x_label: "Normalized time (0-1)"   # X축 라벨 (0=시작, 1=끝)
    y_label: "{channel}"               # Y축 라벨 ({channel}은 동적 치환: TA, RF 등)

  # Forceplate 신호 전용 설정
  forceplate:
    subplot_size: [15, 10]             # 그리드 크기 (가로, 세로) 인치
    line_colors:                       # 각 채널별 라인 색상 매핑
      Fx: "purple"                     # 전후방향 힘 (보라)
      Fy: "brown"                      # 좌우방향 힘 (갈색)
      Fz: "green"                      # 수직 힘 (초록)
    axis_labels:
      Fx: "AP Force (Ant: + / Post: -)"
      Fy: "ML Force (Left: + / Right: -)"
      Fz: "Vertical Force (Down: + / Up: -)"
      Mx: "Mx (Ant Down: + / Post Down: -)"
      My: "My (Left Up: + / Right Up: -)"
      Mz: "Mz (CW: + / CCW: -)"
    line_width: 1.2                    # 라인 두께
    line_alpha: 0.8                    # 라인 투명도
    window_span_alpha: 0.15            # 윈도우 배경 투명도
    legend_fontsize: 5                 # legend 폰트 크기 (채널 수가 적어서 크게)
    x_label: "Normalized time (0-1)"   # X축 라벨
    y_label: "{axis_label}"            # Y축 라벨 (축 방향 설명)

  # COP (Center of Pressure) 신호 전용 설정
  cop:
    subplot_size: [18, 5]              # 그리드 크기 (가로, 세로) 인치 (1×3 mixed plot)
    scatter_size: 8                    # 산점도 점 크기 (마커 크기)
    scatter_alpha: 0.7                 # 산점도 점 투명도 (궤적 시각화용)
    background_color: "lightgray"      # 배경 색상
    background_alpha: 0.3              # 배경 투명도
    background_size: 6                 # 배경 점 크기
    window_span_alpha: 0.15            # 시계열 플롯의 윈도우 배경 투명도
    line_colors:
      Cx: "blue"
      Cy: "red"
    line_width: 1.2
    line_alpha: 0.8
    max_marker_color: "#ED1C24"        # 최댓값 마커 색상 (빨강)
    max_marker_size: 80                # 최댓값 마커 크기 (통상 점보다 큼)
    max_marker_symbol: "*"             # 최댓값 마커 모양 ("*"=별, "o"=원, "s"=사각형)
    max_marker_edgecolor: "white"      # 최댓값 마커 테두리 색상
    max_marker_linewidth: 1            # 최댓값 마커 테두리 두께
    max_marker_zorder: 10              # 최댓값 마커 겹침순서 (값 클수록 위에)
    legend_fontsize: 5                 # legend 폰트 크기
    x_label_time: "Normalized time (0-1)"
    y_label_cx: "COP AP (Ant: + / Post: -)"
    y_label_cy: "COP ML (Left: + / Right: -)"
    x_label: "COP ML (Left: + / Right: -)"
    y_label: "COP AP (Ant: + / Post: -)"
    y_invert: false                    # Y축 반전 여부 (true면 위쪽이 음수)

  # COM (Center of Mass) 신호 전용 설정
  com:
    y_label_comx: "COM AP (Ant: + / Post: -)"
    y_label_comy: "COM ML (Left: + / Right: -)"
    y_label_comz: "COMz"
    x_label: "COM ML (Left: + / Right: -)"
    y_label: "COM AP (Ant: + / Post: -)"

# === Window Definitions (relative to platform_onset in ms) ===
windows:
  reference_event: "platform_onset"
  definitions:
    p1:
      start_ms: 0
      end_ms: 200
    p2:
      start_ms: 200
      end_ms: 400
    p3:
      start_ms: 400
      end_ms: 600
    p4:
      start_ms: 600
      end_ms: 800

# === Event Vertical Lines (data-driven annotations) ===
# Notes:
# - Values are interpreted in the same domain as `data.id_columns.onset` (platform_onset; mocap frame).
# - The visual style is controlled via `event_vlines.style` (matplotlib axvline kwargs).
# - Each column gets a different color from a palette by default.
# - If you want a specific column color, set it in `event_vlines.colors`.
event_vlines:
  columns: ["platform_onset", "step_onset"]
  # Optional:
  # colors:
  #   platform_onset: "black"
  # Optional (default: matplotlib C0..C9):
  # palette: ["C0", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9"]
  style:
    linestyle: "--"
    linewidth: 1.5
    alpha: 0.9

# === Figure Layout ===
figure_layout:
  summary_plots:
    onset:
      max_cols: 99

# === Output Settings ===
output:
  base_dir: "output"

# === CoP Crossing-based EMG Analysis ===
# NOTE: This analysis computes CoP(step vs nonstep) crossings from merged.parquet directly
# and defines EMG windows based on those crossings (no precomputed feature reuse).
cop_crossing_emg_analysis:
  enabled: true
  filter:
    mixed: 1
    age_group: "young"
  cop_columns: ["Cx_zero", "Cy_zero"]
  # If null, fallback to interpolation.start_ms / interpolation.end_ms
  time_window_ms:
    start_ms: null
    end_ms: null
  crossing:
    # Moving-average smoothing (ms) applied to CoP diff curve for stable crossing detection.
    smoothing_ms: 11
    diff_epsilon: 0.0
    min_segment_ms: 10
    primary_crossing_policy: "first_after_onset"
  crossing_window_ms: 50
  # EMG may lag behind CoP changes. We scan a common lag (ms) applied to EMG windows:
  # phase time t uses EMG at (t + lag).
  emg_lag_scan_ms:
    start_ms: 0
    end_ms: 150
    step_ms: 10
  metrics: ["mean", "iemg", "peak"]
  output_subdir: "cop_crossing_emg"
  report_path: "report/cop_crossing_emg_report.md"
