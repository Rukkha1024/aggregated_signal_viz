# === Aggregation Modes ===
aggregation_modes:
  step_TF_mean:
    enabled: true
    filter:
      mixed: 1
      age_group: "young"
    groupby: ["step_TF"]
    color_by: ["step_TF"]
    overlay: true
    overlay_within: ["step_TF"]
    output_dir: "step_TF"
    filename_pattern: "step_TF_mean_{signal_group}.png"
  diff_step_TF_subject_mean:
    enabled: true
    filter:
      mixed: 1
      age_group: "young"
    groupby: ["step_TF","subject"]
    color_by: ["step_TF"]
    overlay: true
    overlay_within: ["step_TF"]
    output_dir: "step_TF_subject_mean"
    filename_pattern: "step_TF_{subject}_mean_{signal_group}.png"
  # diff_step_TF_subject:
  #   enabled: true
  #   filter:
  #     mixed: 1
  #     age_group: "young"
  #   groupby: ["step_TF", "subject", "velocity", "trial_num"]
  #   color_by: ["step_TF"]
  #   overlay: true
  #   overlay_within: ["step_TF"]
  #   output_dir: "step_TF_subject"
  #   filename_pattern: "step_TF_{subject}_v{velocity}_{trial_num}_{signal_group}.png"

# === Output Settings ===
output:
  base_dir: "output"
  # When true, write Plotly HTML alongside each generated PNG (same filename stem).
  plotly_html: false
  # When true, additionally write EMG "trial grid by channel" Plotly HTML outputs.
  # Strict policy: enabled modes must be trial-level (groupby includes subject/velocity/trial) or the run aborts.
  emg_trial_grid_by_channel: false

# === Interpolation ===
interpolation:
  target_length: 500  # resampling length (number of time points)
  start_ms: -100  # null이면 데이터 시작부분부터. default: -100
  end_ms: 500    # null이면 데이터 끝부분까지. default: 800

# === X-axis Zeroing ===
# 기준값은 각 플롯(또는 파일)에 포함된 trial들의 `reference_event` 평균 시점입니다.
x_axis_zeroing:
  enabled: true
  reference_event: "TKEO_AGLR_emg_onset_timing"

# === Window Definitions (ms) ===
# 참고:
# - `windows.reference_event`는 *숫자형* 윈도우 경계(start_ms/end_ms)의 기준(0점)을 정의합니다.
#   - `data.id_columns.onset`(platform_onset)과 같으면, 숫자값은 platform_onset 기준 ms입니다.
#   - 그 외의 이벤트이면, 숫자값은 `reference_event` 기준 ms 오프셋으로 해석됩니다(해당 이벤트의 평균 timing만큼 shift 적용).
# - `windows.definitions.*.start_ms/end_ms`는 아래 형식을 모두 지원합니다.
#   - 숫자: 오프셋 ms(위 규칙 적용)
#   - 문자열: 이벤트 컬럼명(platform_onset 기준 ms timing)
#   - 문자열(표현식): "<event> +/- <ms>" (예: "TKEO_AGLR_emg_onset_timing + 30")
# - 이벤트 컬럼은 아래 두 곳에서 올 수 있습니다.
#   1) `data.input_file`: `data.id_columns.onset`과 동일한 도메인(mocap frame)으로 해석 후 ms로 변환
#   2) `data.features_file`만 존재: platform_onset 기준 ms로 해석
windows:
  reference_event: "platform_onset"
  definitions:
    p1:
      start_ms: "TKEO_AGLR_emg_onset_timing"
      end_ms: "TKEO_AGLR_emg_onset_timing + 125"
    p2:
      start_ms: "TKEO_AGLR_emg_onset_timing + 125"
      end_ms: "step_onset"
    p3:
      start_ms: "step_onset"
      end_ms: "600"


# === CoP Crossing-based EMG Analysis ===
# NOTE: This analysis computes CoP(step vs nonstep) crossings from merged.parquet directly
# and defines EMG windows based on those crossings (no precomputed feature reuse).
cop_crossing_emg_analysis:
  enabled: true
  filter:
    mixed: 1
    age_group: "young"
  cop_columns: ["Cx_zero", "Cy_zero"]
  # If null, fallback to interpolation.start_ms / interpolation.end_ms
  time_window_ms:
    start_ms: null
    end_ms: null
  crossing:
    # Moving-average smoothing (ms) applied to CoP diff curve for stable crossing detection.
    smoothing_ms: 11
    diff_epsilon: 0.0
    min_segment_ms: 10
    primary_crossing_policy: "first_after_onset"
  crossing_window_ms: 50
  # EMG may lag behind CoP changes. We scan a common lag (ms) applied to EMG windows:
  # phase time t uses EMG at (t + lag).
  emg_lag_scan_ms:
    start_ms: 0
    end_ms: 150
    step_ms: 10
  metrics: ["mean", "iemg", "peak"]
  output_subdir: "cop_crossing_emg"
  report_path: "report/cop_crossing_emg_report.md"

# === Data Settings ===
data:
  input_file: "data/merged.parquet"
  features_file: "/mnt/c/Users/Alice/OneDrive - 청주대학교/근전도 분석 코드/EMG_analysis/output/meta_merged.csv"
  id_columns:
    subject: "subject"
    velocity: "velocity"
    trial: "trial_num"
    frame: "DeviceFrame"
    mocap_frame: "MocapFrame"
    onset: "platform_onset"
    offset: "platform_offset"
    task: "task"
  task_filter: "perturb"
  # Sampling rates (MocapFrame → DeviceFrame)
  device_sample_rate: 1000
  mocap_sample_rate: 100
